<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jolly Phonics Listening Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            padding: 20px;
            color: white;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .back-to-dictionary {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .back-to-dictionary:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
        }

        .group-selector {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .group-selector h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

        .groups-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .group-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .group-card:hover {
            border-color: #667eea;
            background: #fff;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .group-card.available {
            border-color: #28a745;
            background: #d4edda;
        }

        .group-card.unavailable {
            border-color: #dc3545;
            background: #f8d7da;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .group-card.advanced-group {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .group-card.advanced-group .group-number {
            color: #fff;
        }

        .group-card.advanced-group .group-letters {
            color: #e8f4f8;
        }

        .group-card.advanced-group .group-description {
            color: #f0f8ff;
            font-style: italic;
        }

        .group-card.advanced-group:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .group-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .group-letters {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .group-description {
            font-size: 0.9em;
            margin-bottom: 8px;
            color: #666;
        }

        .group-words-count {
            color: #666;
            font-size: 0.9em;
        }

        .test-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none;
        }

        /* Mode selector */
        .mode-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 18px;
            justify-content: center;
            background: #f8f9ff;
            border: 1px solid #e3e7ff;
            border-radius: 12px;
            padding: 10px 12px;
        }
        .mode-controls label {
            font-weight: 600;
            color: #333;
        }
        .mode-controls select {
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid #ced4da;
            background: #fff;
            box-shadow: 0 1px 2px rgba(0,0,0,0.06);
        }

        .test-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .test-progress {
            background: #e9ecef;
            height: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .test-progress-bar {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            transition: width 0.3s;
            border-radius: 5px;
        }

        .question-container {
            text-align: center;
            margin-bottom: 30px;
        }

        .question-number {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 15px;
        }

        .audio-player {
            margin: 20px 0;
        }

        .play-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 50px;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .play-button:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }

        .play-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .letter-boxes {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .letter-box {
            width: 60px;
            height: 60px;
            border: 3px solid #dee2e6;
            border-radius: 8px;
            font-size: 1.5em;
            text-align: center;
            background: white;
            transition: all 0.3s;
            outline: none;
        }

        .letter-box:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .letter-box.correct {
            border-color: #28a745;
            background: #d4edda;
        }

        .letter-box.incorrect {
            border-color: #dc3545;
            background: #f8d7da;
        }

        .controls {
            text-align: center;
            margin-top: 30px;
        }

        /* Gap mode UI */
        .masked-word { /* kept for backward compatibility */
            font-size: 2em;
            letter-spacing: 4px;
            margin: 10px 0 20px 0;
        }
        .masked-grid {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin: 10px 0 20px 0;
            flex-wrap: wrap;
        }
        .fixed-box,
        .gap-box {
            width: 48px;
            height: 60px;
            border: 3px solid #dee2e6;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: 700;
            background: #fff;
            color: #333;
        }
        .fixed-box {
            border-color: #d1d9ff;
            background: #eef2ff;
            color: #3f51b5;
        }
        .gap-box {
            border-style: dashed;
            border-color: #b3b9c6;
            background: #fff;
            color: transparent; /* empty visual */
        }
        .gap-input {
            width: min(320px, 90%);
            padding: 12px 14px;
            border: 3px solid #dee2e6;
            border-radius: 8px;
            font-size: 1.2em;
            text-align: center;
            transition: all 0.3s;
            outline: none;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }
        .gap-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .gap-input.correct {
            border-color: #28a745;
            background: #d4edda;
        }
        .gap-input.incorrect {
            border-color: #dc3545;
            background: #f8d7da;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            margin: 0 10px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .result-container {
            text-align: center;
            display: none;
        }

        .score {
            font-size: 3em;
            font-weight: bold;
            color: #28a745;
            margin: 20px 0;
        }

        .feedback {
            font-size: 1.2em;
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
        }

        .feedback.excellent {
            background: #d4edda;
            color: #155724;
        }

        .feedback.good {
            background: #fff3cd;
            color: #856404;
        }

        .feedback.needs-practice {
            background: #f8d7da;
            color: #721c24;
        }

        .immediate-feedback {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 500;
            text-align: center;
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        .immediate-feedback.correct {
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }

        .immediate-feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #dc3545;
        }

        .correct-answer {
            font-weight: bold;
            font-size: 1.2em;
            margin-top: 10px;
        }

        .mistakes-review {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: left;
        }

        .mistakes-review h3 {
            color: #dc3545;
            margin-bottom: 15px;
            text-align: center;
        }

        .mistake-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mistake-word {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .mistake-details {
            text-align: right;
        }

        .your-answer {
            color: #dc3545;
            font-weight: bold;
        }

        .correct-answer-review {
            color: #28a745;
            font-weight: bold;
        }

        .play-mistake-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .play-mistake-btn:hover {
            background: #5a67d8;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hidden {
            display: none;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 10px 15px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            backdrop-filter: blur(10px);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
            }

            .groups-grid {
                grid-template-columns: 1fr;
            }

            .letter-boxes {
                gap: 5px;
            }

            .letter-box {
                width: 50px;
                height: 50px;
                font-size: 1.2em;
            }

            .controls {
                display: flex;
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }

            .btn {
                width: 100%;
                max-width: 300px;
                margin: 0;
            }
        }
    </style>
</head>
<body>
    <button class="back-btn" onclick="goHome()" style="display: none;">‚Üê Back to Dictionary</button>

    <div class="header">
    <a href="index.html" class="back-to-dictionary">üìö Back to Dictionary</a>
        <h1>üéµ Jolly Phonics Listening Test</h1>
        <p>Listen carefully and write the letters you hear</p>
    </div>

    <div class="container">
        <!-- Group Selection -->
        <div class="group-selector" id="groupSelector">
            <h2>Choose Your Jolly Phonics Group</h2>
            <div class="mode-controls">
                <label for="modeSelect">Question Mode:</label>
                <select id="modeSelect">
                    <option value="dictation" selected>Dictation (type full word)</option>
                    <option value="gap">Fill the Gap (missing sound)</option>
                </select>
            </div>
            <div class="groups-grid" id="groupsGrid">
                <!-- Groups will be loaded here -->
            </div>
        </div>

        <!-- Test Interface -->
        <div class="test-container" id="testContainer">
            <div class="test-header">
                <h2 id="testTitle">Group 1 Test</h2>
                <div class="test-progress">
                    <div class="test-progress-bar" id="progressBar" style="width: 0%"></div>
                </div>
                <div class="question-number" id="questionNumber">Question 1 of 10</div>
            </div>

            <div class="question-container">
                <div class="audio-player">
                    <button class="play-button" id="playButton" onclick="playWord()">
                        üîä Play Word
                    </button>
                </div>

                <div class="letter-boxes" id="letterBoxes">
                    <!-- Letter input boxes will be generated here -->
                </div>

                <div class="immediate-feedback" id="immediateFeedback">
                    <!-- Immediate feedback will appear here -->
                </div>

                <div class="controls">
                    <button class="btn btn-secondary" onclick="playWord()">üîä Play Again</button>
                    <button class="btn btn-primary" id="submitBtn" onclick="submitAnswer()" disabled>Submit Answer</button>
                    <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()" style="display: none;">Next Question</button>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div class="result-container" id="resultContainer">
            <h2>üéâ Test Complete!</h2>
            <div class="score" id="finalScore">8/10</div>
            <div class="feedback" id="feedback">Excellent work!</div>
            
            <!-- Mistakes Review Section -->
            <div class="mistakes-review" id="mistakesReview" style="display: none;">
                <h3>üìù Review Your Mistakes</h3>
                <div id="mistakesList">
                    <!-- Mistakes will be listed here -->
                </div>
            </div>
            
            <div class="controls">
                <button class="btn btn-primary" onclick="restartTest()">Try Again</button>
                <button class="btn btn-success" onclick="chooseAnotherGroup()">üìã Choose Another Group</button>
                <button class="btn btn-secondary" onclick="goHome()">Back to Dictionary</button>
            </div>
        </div>
    </div>

    <script>
        let jollyPhonicData = {};
        let currentGroup = null;
        let currentTest = [];
        let currentQuestion = 0;
        let score = 0;
        let currentWord = null;
        let currentAudio = null;
    let mistakes = []; // Track mistakes for review
    let testMode = 'dictation'; // 'dictation' | 'gap'
    let isAdvancedTest = false; // track whether current run is advanced (8-10)

        // Load Jolly Phonics data
        async function loadJollyPhonicsData() {
            try {
                const response = await fetch('jolly_phonics_words.json?t=' + Date.now());
                jollyPhonicData = await response.json();
                renderGroupSelector();
            } catch (error) {
                console.error('Could not load Jolly Phonics data:', error);
                alert('Could not load test data. Make sure jolly_phonics_analyzer.py has been run.');
            }
        }

        function renderGroupSelector() {
            const grid = document.getElementById('groupsGrid');
            grid.innerHTML = '';

            // Render Groups 1-7 (Basic Jolly Phonics)
            for (let i = 1; i <= 7; i++) {
                const groupData = jollyPhonicData.groups[i.toString()];
                const card = document.createElement('div');
                
                const wordCount = groupData ? groupData.word_count : 0;
                const isAvailable = wordCount >= 3; // Need at least 3 words for a test
                
                card.className = `group-card ${isAvailable ? 'available' : 'unavailable'}`;
                card.innerHTML = `
                    <div class="group-number">Group ${i}</div>
                    <div class="group-letters">${groupData ? groupData.letters.join(', ') : ''}</div>
                    <div class="group-words-count">${wordCount} words available</div>
                `;

                if (isAvailable) {
                    card.onclick = () => startTest(i);
                }

                grid.appendChild(card);
            }

            // Render Groups 8-10 (Advanced Phonics)
            const advancedGroups = {
                8: { name: 'Split Digraphs', letters: ['a-e', 'i-e', 'o-e', 'u-e', 'e-e'], description: 'Magic E patterns' },
                9: { name: 'Alternative Vowels', letters: ['ai/ay', 'ee/ea', 'igh/ie', 'oa/ow', 'oo/ue'], description: 'Different vowel spellings' },
                10: { name: 'Alternative Consonants', letters: ['ph/f', 'c/k', 'c/s', 'ge/j', 'gn/n'], description: 'Different consonant spellings' }
            };

            for (let i = 8; i <= 10; i++) {
                const groupInfo = advancedGroups[i];
                const card = document.createElement('div');
                
                // For now, assume these groups are available when we implement them
                const isAvailable = true; // Will be updated when we have data
                
                card.className = `group-card advanced-group ${isAvailable ? 'available' : 'unavailable'}`;
                card.innerHTML = `
                    <div class="group-number">Group ${i}</div>
                    <div class="group-letters">${groupInfo.letters.join(', ')}</div>
                    <div class="group-description">${groupInfo.description}</div>
                    <div class="group-words-count">Advanced Phonics</div>
                `;

                if (isAvailable) {
                    card.onclick = () => startAdvancedTest(i);
                }

                grid.appendChild(card);
            }
        }

        function getSelectedMode() {
            const sel = document.getElementById('modeSelect');
            return sel ? sel.value : 'dictation';
        }

        function getGroupLetters(groupNumber) {
            // For basic groups (1‚Äì7), pull from data
            if (groupNumber >= 1 && groupNumber <= 7) {
                const gd = jollyPhonicData.groups[groupNumber.toString()];
                return gd ? gd.letters || [] : [];
            }
            // For advanced groups, mirror the labels we show on cards
            const advancedLetters = {
                8: ['a-e', 'i-e', 'o-e', 'u-e', 'e-e'],
                9: ['ai/ay', 'ee/ea', 'igh/ie', 'oa/ow', 'oo/ue'],
                10: ['ph/f', 'c/k', 'c/s', 'ge/j', 'gn/n']
            };
            return advancedLetters[groupNumber] || [];
        }

        function startTest(groupNumber) {
            currentGroup = groupNumber;
            isAdvancedTest = false;
            testMode = getSelectedMode();
            const groupData = jollyPhonicData.groups[groupNumber.toString()];
            
            // Prepare test words (up to 10)
            const allWords = Object.keys(groupData.words);
            const testWords = allWords.sort(() => 0.5 - Math.random()).slice(0, Math.min(10, allWords.length));
            
            currentTest = testWords.map(word => {
                const wordData = groupData.words[word];
                // Prefer UK accent, fallback to US
                const audioFile = wordData.find(w => w.accent === 'uk') || wordData[0];
                const base = {
                    word: word,
                    audioPath: audioFile.path,
                    letters: word.split('')
                };
                return base;
            });

            // Reset test state
            currentQuestion = 0;
            score = 0;
            mistakes = []; // Reset mistakes for new test
            
            // Show test interface
            document.getElementById('groupSelector').style.display = 'none';
            document.getElementById('testContainer').style.display = 'block';
            document.querySelector('.back-btn').style.display = 'block';
            
            // Update title
            document.getElementById('testTitle').textContent = `Group ${groupNumber} Test ‚Äî ${testMode === 'gap' ? 'Fill the Gap' : 'Dictation'}`;
            
            loadQuestion();
        }

        function startAdvancedTest(groupNumber) {
            currentGroup = groupNumber;
            isAdvancedTest = true;
            testMode = getSelectedMode();
            
            // Load advanced phonics words from our config
            const advancedGroups = {
                8: 'split_digraphs',
                9: 'alternative_vowels', 
                10: 'alternative_consonants'
            };
            
            const groupType = advancedGroups[groupNumber];
            
            // Load words from our advanced phonics configuration
            const testWords = getAdvancedTestWords(groupType);
            
            currentTest = testWords.map(word => {
                const baseWord = String(word).toLowerCase().trim();
                // build a list of candidate paths to try later in playWord()
                const folder = `advanced_phonics_sounds/${groupType}`;
                const candidates = [
                    `${folder}/${baseWord}_us.mp3`,
                    `${folder}/${baseWord}_uk.mp3`,
                    `${folder}/${baseWord}.mp3`,
                    `US/${baseWord}.mp3`,
                    `UK/${baseWord}.mp3`,
                    `US/${baseWord}_us.mp3`,
                    `UK/${baseWord}_gb.mp3`
                ];
                return {
                    word: baseWord,
                    audioPath: candidates[0],
                    audioCandidates: candidates,
                    letters: baseWord.split('')
                };
            });

            // Reset test state
            currentQuestion = 0;
            score = 0;
            mistakes = []; // Reset mistakes for new test
            
            // Show test interface
            document.getElementById('groupSelector').style.display = 'none';
            document.getElementById('testContainer').style.display = 'block';
            document.querySelector('.back-btn').style.display = 'block';
            
            // Update title
            const groupNames = {8: 'Split Digraphs', 9: 'Alternative Vowels', 10: 'Alternative Consonants'};
            document.getElementById('testTitle').textContent = `Group ${groupNumber}: ${groupNames[groupNumber]} Test ‚Äî ${testMode === 'gap' ? 'Fill the Gap' : 'Dictation'}`;
            
            loadQuestion();
        }

        function getAdvancedTestWords(groupType) {
            // Sample words for each advanced group - in production this would come from the config
            const wordSets = {
                'split_digraphs': ['cake', 'bike', 'home', 'cute', 'these', 'make', 'like', 'bone', 'tune', 'complete'],
                'alternative_vowels': ['rain', 'play', 'tree', 'sea', 'night', 'pie', 'boat', 'snow', 'moon', 'blue'],
                'alternative_consonants': ['phone', 'graph', 'cat', 'kite', 'city', 'ice', 'page', 'cage', 'sign', 'gnome']
            };
            
            const words = wordSets[groupType] || [];
            // Shuffle and take up to 10 words
            return words.sort(() => 0.5 - Math.random()).slice(0, Math.min(10, words.length));
        }

    function buildGapForWord(word, groupNumber) {
            // Try to hide a grapheme from the current group's letters; prefer multi-letter first
            const letters = getGroupLetters(groupNumber)
                .slice()
                .sort((a,b) => (b.length||0) - (a.length||0));
            const lower = word.toLowerCase();
            // explode composite labels like 'ai/ay' into candidates
            const expand = (token) => token.includes('/') ? token.split('/').map(s=>s.trim()) : [token];
            let candidates = [];
            for (const t of letters) candidates.push(...expand(t));
            // de-dup and sort by length desc again
            candidates = Array.from(new Set(candidates)).sort((a,b)=>b.length-a.length);

            // Special handling for split digraphs (magic E): look for pattern like a_e, i_e, o_e, u_e, e_e
            const splitDigraphs = ['a_e','e_e','i_e','o_e','u_e'];
            let idx = -1, missing = '', len = 0;
            for (const sd of splitDigraphs) {
                // Find pattern: letter, any consonant, e at end
                // e.g., bike: b i k e, idx=1, missing=i_e
                // e.g., make: m a k e, idx=1, missing=a_e
                const v = sd[0];
                if (lower.length >= 4 && lower.endsWith('e')) {
                    // Look for v _ _ e pattern
                    for (let i = 0; i < lower.length - 2; i++) {
                        if (lower[i] === v && lower[lower.length-1] === 'e') {
                            // Confirm the pattern is v + consonant + e at the end
                            if (i+2 === lower.length-1) {
                                idx = i;
                                missing = v + '_e';
                                len = 2; // gap both vowel and e
                                break;
                            }
                        }
                    }
                }
                if (idx !== -1) break;
            }
            // If not split digraph, proceed as before
            if (idx === -1) {
                for (const pat of candidates) {
                    if (!pat) continue;
                    const i = lower.indexOf(pat);
                    if (i !== -1) {
                        idx = i; missing = pat; len = pat.length; break;
                    }
                }
            }
            // fallback: hide a random single letter
            if (idx === -1) {
                idx = Math.max(0, Math.floor(Math.random() * Math.max(1, lower.length)));
                len = 1; missing = lower.charAt(idx);
            }
            const placeholder = '____'.slice(0, Math.max(1, len));
            const masked = word.substring(0, idx) + placeholder + word.substring(idx+len);
            return { start: idx, length: len, missing, masked };
        }

        function loadQuestion() {
            if (currentQuestion >= currentTest.length) {
                showResults();
                return;
            }

            const question = currentTest[currentQuestion];
            currentWord = question;

            // Update progress
            const progress = ((currentQuestion) / currentTest.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('questionNumber').textContent = `Question ${currentQuestion + 1} of ${currentTest.length}`;

            // Create input UI according to mode
            const container = document.getElementById('letterBoxes');
            container.innerHTML = '';

            if (testMode === 'dictation') {
                for (let i = 0; i < question.letters.length; i++) {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'letter-box';
                    input.maxLength = 1;
                    input.addEventListener('input', handleLetterInput);
                    input.addEventListener('keydown', handleKeyDown);
                    container.appendChild(input);
                }
                if (container.firstChild) container.firstChild.focus();
            } else {
                const gap = buildGapForWord(question.word, currentGroup);
                currentWord.gap = gap;
                // Build a boxy masked grid rendering
                const grid = document.createElement('div');
                grid.className = 'masked-grid';
                
                // Special handling for split digraphs (a_e, i_e, etc.)
                if (/^[aeiou]_e$/.test(gap.missing)) {
                    // For split digraphs, show: consonant(s) + gap + consonant(s) + gap
                    // e.g., "cake" with missing "a_e" shows: C _ K _
                    for (let i = 0; i < question.word.length; i++) {
                        if (i === gap.start) {
                            // Gap for the vowel
                            const gb1 = document.createElement('div');
                            gb1.className = 'gap-box';
                            gb1.title = 'Fill this gap';
                            grid.appendChild(gb1);
                        } else if (i === question.word.length - 1 && question.word[i] === 'e') {
                            // Gap for the final 'e'
                            const gb2 = document.createElement('div');
                            gb2.className = 'gap-box';
                            gb2.title = 'Fill this gap';
                            grid.appendChild(gb2);
                        } else {
                            const fb = document.createElement('div');
                            fb.className = 'fixed-box';
                            fb.textContent = question.word[i].toUpperCase();
                            grid.appendChild(fb);
                        }
                    }
                } else {
                    // Regular gap handling for non-split digraphs
                    let i = 0;
                    while (i < question.word.length) {
                        if (i === gap.start) {
                            // Render one gap box per missing letter
                            for (let j = 0; j < gap.length; j++) {
                                const gb = document.createElement('div');
                                gb.className = 'gap-box';
                                gb.title = 'Fill this gap';
                                grid.appendChild(gb);
                            }
                            i += gap.length;
                            continue;
                        }
                        const fb = document.createElement('div');
                        fb.className = 'fixed-box';
                        fb.textContent = question.word[i].toUpperCase();
                        grid.appendChild(fb);
                        i++;
                    }
                }
                const gapInput = document.createElement('input');
                gapInput.type = 'text';
                gapInput.id = 'gapInput';
                gapInput.className = 'gap-input';
                gapInput.placeholder = 'Type the missing sound';
                gapInput.maxLength = Math.max(2, gap.length);
                gapInput.addEventListener('input', () => {
                    const hasText = gapInput.value.trim().length > 0;
                    document.getElementById('submitBtn').disabled = !hasText;
                });
                container.appendChild(grid);
                container.appendChild(gapInput);
                gapInput.focus();
            }

            // Hide immediate feedback
            document.getElementById('immediateFeedback').style.display = 'none';

            // Reset buttons
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('playButton').disabled = false;

            // Auto-play the word
            setTimeout(() => playWord(), 500);
        }

        function handleLetterInput(event) {
            const input = event.target;
            const value = input.value.toLowerCase();
            
            // Move to next box if current is filled
            if (value && input.nextSibling) {
                input.nextSibling.focus();
            }

            checkIfComplete();
        }

        function handleKeyDown(event) {
            const input = event.target;
            
            // Backspace: move to previous box if current is empty
            if (event.key === 'Backspace' && !input.value && input.previousSibling) {
                input.previousSibling.focus();
            }
            
            // Enter: submit if complete
            if (event.key === 'Enter' && !document.getElementById('submitBtn').disabled) {
                submitAnswer();
            }
        }

        function checkIfComplete() {
            const inputs = document.querySelectorAll('.letter-box');
            const allFilled = Array.from(inputs).every(input => input.value.trim() !== '');
            document.getElementById('submitBtn').disabled = !allFilled;
        }

        function playWord() {
            if (currentAudio) {
                currentAudio.pause();
            }

            // Try multiple candidate sources for robustness (esp. advanced groups)
            const sources = currentWord.audioCandidates && currentWord.audioCandidates.length
                ? [...currentWord.audioCandidates]
                : [currentWord.audioPath];

            const audio = document.createElement('audio');
            audio.preload = 'auto';

            let idx = 0;
            function tryNext() {
                if (idx >= sources.length) {
                    console.error('Audio playback failed: no source found');
                    alert('Could not play audio. Make sure the audio file exists.');
                    return;
                }
                const src = sources[idx];
                audio.src = `${src}?t=${Date.now()}`;
                audio.onloadeddata = () => {
                    audio.play().catch(() => {
                        idx++;
                        tryNext();
                    });
                };
                audio.onerror = () => {
                    idx++;
                    tryNext();
                };
                audio.load();
            }
            currentAudio = audio;
            tryNext();

            // Disable play button briefly to prevent spam
            const playBtn = document.getElementById('playButton');
            playBtn.disabled = true;
            setTimeout(() => {
                playBtn.disabled = false;
            }, 1000);
        }

        function submitAnswer() {
            const feedbackElement = document.getElementById('immediateFeedback');
            const correctAnswer = currentWord.word.toLowerCase();

            if (testMode === 'dictation') {
                const inputs = document.querySelectorAll('.letter-box');
                const userAnswer = Array.from(inputs).map(input => input.value.toLowerCase()).join('');
                const isCorrect = userAnswer === correctAnswer;
                inputs.forEach((input, index) => {
                    const userLetter = input.value.toLowerCase();
                    const correctLetter = currentWord.letters[index].toLowerCase();
                    if (userLetter === correctLetter) {
                        input.classList.add('correct');
                        input.classList.remove('incorrect');
                    } else {
                        input.classList.add('incorrect');
                        input.classList.remove('correct');
                    }
                    input.disabled = true;
                });
                if (isCorrect) {
                    score++;
                    feedbackElement.className = 'immediate-feedback correct';
                    feedbackElement.innerHTML = '‚úÖ Correct! Well done!';
                } else {
                    mistakes.push({ word: currentWord.word, userAnswer, correctAnswer, audioPath: currentWord.audioPath });
                    feedbackElement.className = 'immediate-feedback incorrect';
                    feedbackElement.innerHTML = `‚ùå Not quite right.<div class="correct-answer">The correct spelling is: <strong>${correctAnswer.toUpperCase()}</strong></div>`;
                }
            } else {
                const gapInput = document.getElementById('gapInput');
                let userGap = (gapInput?.value || '').toLowerCase().trim();
                let correctGap = (currentWord.gap?.missing || '').toLowerCase();
                // For split digraphs, accept both i_e and ie (user may not type the underscore)
                if (/^[aeiou]_e$/.test(correctGap)) {
                    // Accept with or without underscore
                    if (userGap === correctGap || userGap === correctGap.replace('_','')) {
                        userGap = correctGap; // normalize for review
                    }
                }
                const isCorrect = userGap === correctGap;
                gapInput.disabled = true;
                if (isCorrect) {
                    score++;
                    gapInput.classList.add('correct');
                    feedbackElement.className = 'immediate-feedback correct';
                    feedbackElement.innerHTML = '‚úÖ Correct! Well done!';
                } else {
                    gapInput.classList.add('incorrect');
                    const userShown = currentWord.gap
                        ? (currentWord.word.substring(0, currentWord.gap.start) + userGap + currentWord.word.substring(currentWord.gap.start + currentWord.gap.length))
                        : userGap;
                    mistakes.push({ word: currentWord.word, userAnswer: userShown, correctAnswer, audioPath: currentWord.audioPath });
                    feedbackElement.className = 'immediate-feedback incorrect';
                    feedbackElement.innerHTML = `‚ùå Not quite right.<div class="correct-answer">The correct spelling is: <strong>${correctAnswer.toUpperCase()}</strong></div>`;
                }
            }

            feedbackElement.style.display = 'block';
            document.getElementById('submitBtn').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'inline-block';
        }

        function nextQuestion() {
            currentQuestion++;
            
            // Hide immediate feedback
            document.getElementById('immediateFeedback').style.display = 'none';
            
            // Reset letter boxes
            const inputs = document.querySelectorAll('.letter-box');
            inputs.forEach(input => {
                input.classList.remove('correct', 'incorrect');
                input.disabled = false;
                input.value = '';
            });

            // Reset buttons
            document.getElementById('submitBtn').style.display = 'inline-block';
            document.getElementById('nextBtn').style.display = 'none';

            loadQuestion();
        }

        function showResults() {
            document.getElementById('testContainer').style.display = 'none';
            document.getElementById('resultContainer').style.display = 'block';

            const percentage = Math.round((score / currentTest.length) * 100);
            document.getElementById('finalScore').textContent = `${score}/${currentTest.length} (${percentage}%)`;

            const feedback = document.getElementById('feedback');
            if (percentage >= 90) {
                feedback.textContent = "Excellent! You've mastered this group!";
                feedback.className = 'feedback excellent';
            } else if (percentage >= 70) {
                feedback.textContent = "Good job! Keep practicing to improve.";
                feedback.className = 'feedback good';
            } else {
                feedback.textContent = "Keep practicing! Try listening more carefully.";
                feedback.className = 'feedback needs-practice';
            }

            // Show mistakes review if there are any mistakes
            if (mistakes.length > 0) {
                displayMistakesReview();
            }
        }

        function displayMistakesReview() {
            const mistakesReview = document.getElementById('mistakesReview');
            const mistakesList = document.getElementById('mistakesList');
            
            mistakesList.innerHTML = '';
            
            mistakes.forEach((mistake, index) => {
                const mistakeDiv = document.createElement('div');
                mistakeDiv.className = 'mistake-item';
                mistakeDiv.innerHTML = `
                    <div>
                        <div class="mistake-word">Word: ${mistake.word.toUpperCase()}</div>
                        <button class="play-mistake-btn" onclick="playMistakeAudio('${mistake.audioPath}')">
                            üîä Listen Again
                        </button>
                    </div>
                    <div class="mistake-details">
                        <div>Your answer: <span class="your-answer">${mistake.userAnswer.toUpperCase()}</span></div>
                        <div>Correct answer: <span class="correct-answer-review">${mistake.correctAnswer.toUpperCase()}</span></div>
                    </div>
                `;
                mistakesList.appendChild(mistakeDiv);
            });
            
            mistakesReview.style.display = 'block';
        }

        function playMistakeAudio(audioPath) {
            if (currentAudio) {
                currentAudio.pause();
            }
            
            // Also try multiple fallbacks if the stored path fails
            const base = audioPath.replace(/\?.*$/, '');
            const candidates = [
                base,
                base.replace(/_us\.mp3$/, '_uk.mp3'),
                base.replace(/_uk\.mp3$/, '_us.mp3'),
                base.replace(/advanced_phonics_sounds\/[^/]+\//, 'US/'),
                base.replace(/advanced_phonics_sounds\/[^/]+\//, 'UK/')
            ];
            const audio = document.createElement('audio');
            audio.preload = 'auto';
            let i = 0;
            function tryNext() {
                if (i >= candidates.length) {
                    console.error('Audio playback failed: no source found');
                    alert('Could not play audio. Make sure the audio file exists.');
                    return;
                }
                const src = `${candidates[i]}?t=${Date.now()}`;
                audio.src = src;
                audio.onloadeddata = () => audio.play().catch(() => { i++; tryNext(); });
                audio.onerror = () => { i++; tryNext(); };
                audio.load();
            }
            currentAudio = audio;
            tryNext();
        }

        function restartTest() {
            document.getElementById('resultContainer').style.display = 'none';
            if (isAdvancedTest && currentGroup >= 8) {
                startAdvancedTest(currentGroup);
            } else {
                startTest(currentGroup);
            }
        }

        function chooseAnotherGroup() {
            // Hide results and show group selector
            document.getElementById('resultContainer').style.display = 'none';
            document.getElementById('testContainer').style.display = 'none';
            document.getElementById('groupSelector').style.display = 'block';
            
            // Reset test state
            currentGroup = null;
            currentTest = [];
            currentQuestion = 0;
            score = 0;
            mistakes = [];
        }

        function goHome() {
            window.location.href = 'index.html';
        }

        // Initialize
        window.addEventListener('load', loadJollyPhonicsData);
    </script>
</body>
</html>
